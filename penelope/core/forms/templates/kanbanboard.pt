<html metal:use-macro="main.macros['master']">
  <body metal:fill-slot="body">
    <div ng-app="kanban" ng-controller="KanbanCtrl">
        <div class="page-header">
            <div class="pull-right" tal:content="structure actions.buttons(request)"></div>
            <div class="pull-right online-users" ng-show="emails">
              <span class="label">Online: </span>
              <img ng-repeat="email in emails" height="30" width="30" alt="{{email}}" src="https://www.gravatar.com/avatar/{{gravatar(email)}}" />
            </div>
            <h3 tal:condition="request.model_name">
                 <span tal:condition="request.model_id and hasattr(request.model_class, '__unicode__')"
                       tal:replace="unicode(request.model_instance)"/>
                 <span tal:condition="request.model_id and not hasattr(request.model_class, '__unicode__')"
                       tal:replace="request.model_id"/>
                 <span tal:condition="not request.model_id"
                       tal:replace="unicode(request.model_class.label)"/>
            </h3>
            <button class="btn" ng-show="history.length>0" ng-click="isHistoryCollapsed = !isHistoryCollapsed">Toggle history</button>
        </div>

      <div class="row-fluid">
       <div class="span12">
         <ul class="kanban" ng-init="init('${request.model_instance.id}', '${request.authenticated_user.email}')">

               <!-- Backlog -->
               <li class="span2">
                  <div class="thumbnail">
                      <div class="header_name">
                        Backlog
                        <input id="searchText" type="search" placeholder="Live Search Posts..." ng-model-instant ng-model="searchText" ng-show="backlog.tasks.length>0" />
                      </div>
                      <div class="preloader" ng-show="backlog.loaded==false">
                        <img src="${request.application_url}/fanstatic/por/por_kanban/img/loading.gif"/>
                      </div>

                      <div class="alert alert-block nobacklog" ng-show="backlog.loaded==true && backlog.tasks.length==0">
                            <h4>Warning!</h4>
                            Your query <code>${request.model_instance.backlog_query}</code>
                            didn't return any tickets. Please check if there is no syntax error or a simple typo.
                       </div>

                       <ul class="task_pool" ng-model="backlog.tasks" tal:attributes="draggable">
                         <li class="big_container {{task.priority && 'priority'}} media" id="{{task.id}}" 
                                ng-repeat="task in backlog.tasks | filter:searchText"
                                ng-model="backlog.tasks[$index]"
                                ng-show="task.id">
                             <div class="box_itm media-body">
                               <div class="number pull-right">#{{task.ticket}}</div>
                               <span class="project" style="{{getColor(task.project)}}" title="{{task.customer}}">{{task.project}}</span>
                               <span class="ticket"><a ng-click="openModal(task.url)" href="javascript:void(0)">{{task.summary}}</a></span>
                               <div class="pull-right users">
                                 <a href="javascript:void(0)"  ng-click="task.involvedCollapsed = !task.involvedCollapsed" title="Click to see all involved users:">
                                   <img class="media-object" tooltip="{{task.owner}}"
                                      height="30" width="30" src="https://www.gravatar.com/avatar/{{gravatar(task.owner)}}">
                                 </a>
                                 <div collapse="task.involvedCollapsed">
                                   <img ng-repeat="email in task.involved" tooltip="{{email}}" tooltip-placement="bottom" tooltip-append-to-body="true"
                                        height="30" width="30" alt="{{email}}" src="https://www.gravatar.com/avatar/{{gravatar(email)}}" />
                                 </div>
                               </div>
                               <div ng-show="task.customerrequest">{{task.customerrequest}}</div>
                               <div class="clearfix"></div>
                            </div>
                          </li>
                   </ul>
                 </div>
              </li>
              <!-- Backlog end -->

              <!-- Columns -->
              <li class="span2" ng-repeat="column in columns">
              <div class="thumbnail">
                    <div class="header_name">
                      <button class="btn btn-mini btn-danger pull-right" title="Remove column" ng-disabled="column.tasks.length>0"
                        ng-click="removeColumn($index)">
                        <i class="icon-remove-sign icon-white"></i>
                      </button>
                      <a xeditable tal:condition="draggable"
                         data-ng-model="column.title"
                         href="#" data-type="text" data-title="Enter column name">{{column.title}}</a>
                       <div tal:condition="not draggable">{{column.title}}</div>
                    </div>
                    <div class="WIP {{column.tasks.length > column.wip && 'oversized'}}">WIP: 
                      <a xeditable tal:condition="draggable"
                         data-ng-model="column.wip"
                         href="#" data-type="text" data-title="Enter column WIP">{{column.wip}}</a>
                       <span tal:condition="not draggable">{{column.wip}}</span>
                      </div>

                      <ul class="task_pool" ng-model="column.tasks" tal:attributes="draggable">
                        <li class="big_container {{task.priority && 'priority'}} media" id="{{task.id}}" 
                              ng-repeat="task in column.tasks track by $index"
                              ng-model="columns[$parent.$index].tasks[$index]"
                              ng-show="task.id">
                            <div class="box_itm media-body">
                              <div class="number pull-right">#{{task.ticket}}</div>
                              <span class="project" style="{{getColor(task.project)}}" title="{{task.customer}}">{{task.project}}</span>
                              <span class="ticket"><a ng-click="openModal(task.url)" href="javascript:void(0)">{{task.summary}}</a></span>
                               <div class="pull-right users">
                                 <a href="javascript:void(0)"  ng-click="task.involvedCollapsed = !task.involvedCollapsed" title="Click to see all involved users:">
                                   <img class="media-object" tooltip="{{task.owner}}"
                                      height="30" width="30" src="https://www.gravatar.com/avatar/{{gravatar(task.owner)}}">
                                 </a>
                                 <div collapse="task.involvedCollapsed">
                                   <img ng-repeat="email in task.involved" tooltip="{{email}}" tooltip-placement="bottom" tooltip-append-to-body="true"
                                        height="30" width="30" alt="{{email}}" src="https://www.gravatar.com/avatar/{{gravatar(email)}}" />
                                 </div>
                               </div>
                              <div ng-show="task.customerrequest">{{task.customerrequest}}</div>
                              <div class="clearfix"></div>
                          </div>
                        </li>
                  </ul>
                </div>
            </li>

            </ul>
            <!-- Modal -->
            <div id="ModalTicket" class="modal hide fade" tabindex="-1" role="dialog">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">Ã—</button>
                <h3>Ticket view</h3>
              </div>
              <div class="modal-body">
                <div class="preloader">
                  <img src="${request.application_url}/fanstatic/por/por_kanban/img/loading.gif"/>
                </div>
                <iframe src="" style="zoom:0.60" width="99.6%" height="650" frameborder="0"></iframe>
              </div>
            </div>
            <!--End of modal -->
        </div>
        </div>
        </div>
  </body>
</html>

