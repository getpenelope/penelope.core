<html metal:use-macro="main.macros['master']">
  <body>
    <div metal:fill-slot="main">
      <li tal:replace="structure actions.tabs(request)" />

        <form method="post" action="${request.current_route_url()}">
          <h4>Move selected items bellow from</h4>
          <div class="row-fluid">
            <div class="span3 well"><strong>${current_customer_request}</strong>
              <br/>
              <a href="#" rel="tooltip" data-placement="bottom" data-original-title="Time entries done">${'%.2f' % current_customer_request.timeentries_days}</a> days
              of
              <a href="#" rel="tooltip" data-placement="bottom" data-original-title="Customer requests estimations">${'%.2f' % current_customer_request.estimation_days}</a> days.
            </div>
            <div class="span1" style="padding-top: 20px;">
              <i class="icon-forward"></i>
            </div>
              <div class="span4 well" >
                  <select id="new_cr" name="new_cr" class="i-can-haz-chzn-select" data-placeholder="Choose a new customer request...">
                    <tal:contracts repeat="cr crs">
                      <option value="${cr.id}">${cr.name}</option>
                    </tal:contracts>
                  </select>
                  <script>$('#new_cr').chosen()</script>
              </div>
            </div>

          Select time entries to move: <strong><span id="selected_tes" data-total="0"></span></strong>
          <table class="table-condensed table">
            <thead>
              <th style="width:100px"><input type="checkbox" class="check_all"> Date</th>
              <th>Time entry</th>
              <th style="width:80px">Time (days)</th>
              <th>Ticket</th>
            </thead>
            <tbody>
                <tr tal:repeat="te tes">
                  <td>
                    <input type="checkbox" name="te" value="${te.id}" data-time="${te.hours_as_work_days}">
                    ${te.date}
                  </td>
                  <td>
                    <a href="/admin/TimeEntry/${te.id}">${te.description}</a>
                  </td>
                  <td>
                    ${'%.2f' % te.hours_as_work_days}
                  </td>
                  <td>
                      <a href="${ticket_url(request, te.project, te.ticket)}">#${te.ticket}</a>
                  </td>
                </tr>
            </tbody>

          </table>
          <div class="well">
            <a href="${back_url}" class="btn btn-small btn-warning">Go back</a>
            <button class="btn btn-small btn-success" type="submit" value="move_time_entries" name="submit">
                  <i class="icon-white icon-forward"></i>Move time entries
            </button>
            <button class="btn btn-small btn-success" type="submit" value="move_time_entries_and_tickets" name="submit">
                  <i class="icon-white icon-forward"></i>Move time entries and tickets
            </button>
          </div>
        </form>
        <script>
          function update_te(inputs, stat){
            inputs.each(function(){
              if ($(this).is(':checked')!=stat){
                $(this).attr('checked', stat);
                if (stat===true){
                  t = $(this).data('time');
                }
                else{
                  t = -Math.abs($(this).data('time'));
                }
                update_selected_tes(t);
              }
            });
          };

          function update_selected_tes(t){
            $('#selected_tes').html(function(i) { 
              val = $(this).data('total') + t;
              $(this).data('total', val);
              if (val<0.001){
                return ''
              }
              else {
                return (val).toFixed(2) + ' (days) selected'
              }
            });
          };

          $('input[name="te"]').click(function(){
            if ($(this).is(':checked')){
              t = $(this).data('time');
            }
            else {
              t = -Math.abs($(this).data('time'));
            };
            update_selected_tes(t);
          });

          $('input.check_all').click(function() {
            update_te($(this).closest('form').find('input[type=checkbox]'), $(this).is(':checked'));
           });

          $("a[rel='tooltip']").tooltip();
        </script>

    </div>
  </body>
</html>
